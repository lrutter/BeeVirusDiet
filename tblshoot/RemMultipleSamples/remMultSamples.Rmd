library(edgeR)
library(ggplot2)
library(GGally)
library(EDASeq)
library(utils)



findPairs <- function(data){
  y <- DGEList(counts=data)
  minLib <- min(y$samples$lib.size)
  keep <- rowSums(cpm(y)>3) >= 24
  y <- y[keep, , keep.lib.sizes=FALSE]
  y[[1]] <- betweenLaneNormalization(y[[1]], which="full", round=FALSE)
  Group = sapply(colnames(y), function(x) unlist(strsplit(x,"[.]"))[1])
  design <- model.matrix(~0+Group, data=y$samples)
  colnames(design) <- levels(Group)
  y <- estimateDisp(y, design)
  fit <- glmFit(y, design)
  allPairs = data.frame(Treatment1 = factor(), Treatment2 = factor(), NumberDEG = numeric())
  for (i in 1:(ncol(fit)-1)){
    for (j in (i+1):ncol(fit)){
      contrast=rep(0,ncol(fit))
      contrast[i]=1
      contrast[j]=-1
      lrt <- glmLRT(fit, contrast=contrast)
      lrt <- topTags(lrt, n = nrow(y[[1]]))[[1]]
      lrt <- lrt[which(lrt$FDR<0.05),]
      lrtLength <- nrow(lrt)
      allPairs = rbind(allPairs, data.frame(Treatment1 = factor(unique(Group)[i]), Treatment2 = factor(unique(Group)[j]), NumberDEG = lrtLength))
    }
  }
  allPairs$NumberDEG
}





thisPath <- "/Users/lindz/BeeVirusDiet/edgeR-btwnLane"
beeCounts <-read.delim(file="../../data/AllLaneCount.txt",row.names=1,stringsAsFactors = FALSE)
colnames(beeCounts) <- c("NC.1", "NC.2", "NR.1", "VR.1", "NS.1", "VP.1", "NS.2", "VR.2", "NP.1", "VP.2", "VC.1", "NP.2", "VP.3", "NP.3", "VS.1", "VS.2", "VC.2", "NC.3", "VP.4", "NC.4", "NR.2", "VC.3", "VC.4", "NP.4", "VR.3", "NC.5", "VS.3", "NP.5", "VC.5", "VS.4", "NS.3", "VS.5", "VP.5", "NR.3", "NR.4", "VC.6", "NS.4", "NC.6", "NP.6", "VR.4", "NR.5", "NR.6", "NS.5", "VP.6", "NS.6", "VR.5", "VR.6", "VS.6")
beeCounts <- beeCounts[ , order(names(beeCounts))]

X = NULL
remVals = c(7,8,12,14,19,32,43)

for (j in 1:7){
  for (i in 1:ncol(combn(remVals,j))){
    beeCounts2 = beeCounts[,-combn(remVals,j)[,i]]
    x = findPairs(beeCounts2)
    X = rbind(X, x)
  }
}

R = NULL
for (j in 1:7){
  for (i in 1:ncol(combn(remVals,j))){
    combn(remVals,j)[,i]
    rowName=colnames(beeCounts)[combn(remVals,j)[,i]]
    rowName=paste(rowName, sep="", collapse="_")
    R = rbind(R, rowName)
  }
}

rownames(X) = R
colnames(X) = paste0(allPairs$Treatment1, "_", allPairs$Treatment2)
remTable = X
remTable2 = remTable[order(rowSds(remTable)),]
saveRDS(remTable2,"remTable.rds")

heatmapRem <- heatmap(as.matrix(remTable2), col = cm.colors(256), scale="column", margins=c(5,10))

mdata <- melt(remTable2, id=c())
ggplot(data=mdata, aes(x=X2, y=value, group=X1)) + geom_line(0.1) + theme(axis.text.x = element_text(angle = 90, hjust = 1))