<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="generator" content="pandoc" />

    <meta name="author" content="Lindsay Rutter" />
  
  
  <title>Honey Bees - DESeq</title>

    <script src="DESeq_Script_files/jquery-1.11.3/jquery.min.js"></script>
  <link href="DESeq_Script_files/bootstrap-3.3.2/css/bootstrap.min.css" rel="stylesheet" />
  <script src="DESeq_Script_files/bootstrap-3.3.2/js/bootstrap.min.js"></script>
  <script src="DESeq_Script_files/bootstrap-3.3.2/shim/html5shiv.min.js"></script>
  <script src="DESeq_Script_files/bootstrap-3.3.2/shim/respond.min.js"></script>
  <link href="DESeq_Script_files/highlight-8.4/tomorrow.css" rel="stylesheet" />
  <script src="DESeq_Script_files/highlight-8.4/highlight.pack.js"></script>
  <link href="DESeq_Script_files/fontawesome-4.3.0/css/font-awesome.min.css" rel="stylesheet" />
  <script src="DESeq_Script_files/stickykit-1.1.1/sticky-kit.min.js"></script>
  <script src="DESeq_Script_files/jqueryeasing-1.3/jquery.easing.min.js"></script>
  <link href="DESeq_Script_files/recliner-0.2.2/recliner.css" rel="stylesheet" />
  <script src="DESeq_Script_files/recliner-0.2.2/recliner.min.js"></script>
  <script src="DESeq_Script_files/recliner-0.2.2/onload.js"></script>
  <link href="DESeq_Script_files/packagedocs-0.0.1/pd.css" rel="stylesheet" />
  <script src="DESeq_Script_files/packagedocs-0.0.1/pd.js"></script>
  <script src="DESeq_Script_files/packagedocs-0.0.1/pd-collapse-toc.js"></script>
  
  
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
</head>

<body>

  
  <header class="navbar navbar-white navbar-fixed-top" role="banner" id="header">
    <div class="container">
      <div class="navbar-header">
        <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
                <a href="index.html" class="navbar-brand page-scroll">
        Honey Bees - DESeq
        </a>
      </div>
          </div>
  </header>

  <!-- Begin Body -->
  <div class="container">
    <div class="row">
            <div class="col-md-12">
      
<div id="content-top"></div>
<p><meta http-equiv="content-type" content="text/html;charset=utf-8" /></p>
<pre class="r"><code>library(DESeq2)

thisPath &lt;- &quot;/Users/lindz/BeeVirusDiet/DESeq&quot;

beeCounts &lt;-read.delim(file=&quot;../AllLaneCount.txt&quot;,row.names=1,stringsAsFactors = FALSE)
colnames(beeCounts) &lt;- c(&quot;NC.1&quot;, &quot;NC.2&quot;, &quot;NR.1&quot;, &quot;VR.1&quot;, &quot;NS.1&quot;, &quot;VP.1&quot;, &quot;NS.2&quot;, &quot;VR.2&quot;, &quot;NP.1&quot;, &quot;VP.2&quot;, &quot;VC.1&quot;, &quot;NP.2&quot;, &quot;VP.3&quot;, &quot;NP.3&quot;, &quot;VS.1&quot;, &quot;VS.2&quot;, &quot;VC.2&quot;, &quot;NC.3&quot;, &quot;VP.4&quot;, &quot;NC.4&quot;, &quot;NR.2&quot;, &quot;VC.3&quot;, &quot;VC.4&quot;, &quot;NP.4&quot;, &quot;VR.3&quot;, &quot;NC.5&quot;, &quot;VS.3&quot;, &quot;NP.5&quot;, &quot;VC.5&quot;, &quot;VS.4&quot;, &quot;NS.3&quot;, &quot;VS.5&quot;, &quot;VP.5&quot;, &quot;NR.3&quot;, &quot;NR.4&quot;, &quot;VC.6&quot;, &quot;NS.4&quot;, &quot;NC.6&quot;, &quot;NP.6&quot;, &quot;VR.4&quot;, &quot;NR.5&quot;, &quot;NR.6&quot;, &quot;NS.5&quot;, &quot;VP.6&quot;, &quot;NS.6&quot;, &quot;VR.5&quot;, &quot;VR.6&quot;, &quot;VS.6&quot;)
countdata &lt;- beeCounts[ , order(names(beeCounts))]
countdata &lt;- as.matrix(countdata)

coldata = data.frame(row.names = colnames(countdata), virus = unlist(lapply(colnames(countdata), function (x) substring(unlist(strsplit(x, &quot;[.]&quot;))[1],1,1))), diet = unlist(lapply(colnames(countdata), function (x) substring(unlist(strsplit(x, &quot;[.]&quot;))[1],2,2))), treatment = unlist(lapply(colnames(countdata), function (x) unlist(strsplit(x, &quot;[.]&quot;))[1])))

# Not sure which to do
#dds = DESeqDataSetFromMatrix(countData = countdata, colData = coldata, design = ~ virus + diet + virus:diet)
#dds = DESeqDataSetFromMatrix(countData = countdata, colData = coldata, design = ~ virus + diet + virus:diet)
dds = DESeqDataSetFromMatrix(countData = countdata, colData = coldata, design = ~ treatment)
dds &lt;- DESeq(dds)</code></pre>
<pre><code>estimating size factors</code></pre>
<pre><code>estimating dispersions</code></pre>
<pre><code>gene-wise dispersion estimates</code></pre>
<pre><code>mean-dispersion relationship</code></pre>
<pre><code>final dispersion estimates</code></pre>
<pre><code>fitting model and testing</code></pre>
<pre class="r"><code>res &lt;- results(dds, contrast=c(&quot;treatment&quot;,&quot;NC&quot;,&quot;NP&quot;))</code></pre>
<p>We can examine pairwise combinations of all samples</p>
<pre class="r"><code>uTreat &lt;- unique(unlist(lapply(colnames(countdata), function (x) unlist(strsplit(x, &quot;[.]&quot;))[1])))

allPairs = data.frame(Treatment1 = factor(), Treatment2 = factor(), NumberDEG = numeric())

signList = data.frame(Treatment1 = factor(), Treatment2 = factor(), Positive = numeric(), Negative = numeric())

for (i in 1:(length(uTreat)-1)){
  for (j in (i+1):length(uTreat)){
    res &lt;- results(dds, contrast=c(&quot;treatment&quot;,uTreat[i],uTreat[j]))
    #degLength &lt;- length(which((res@listData)$padj &lt;0.05))
    #allPairs = rbind(allPairs, data.frame(Treatment1 = uTreat[i], Treatment2 = uTreat[j], NumberDEG = degLength))
    degs &lt;- which((res@listData)$padj &lt;0.05)
    signList = rbind(signList, data.frame(Treatment1 = uTreat[i], Treatment2 = uTreat[j], Positive = length(which(res@listData$stat[degs] &gt;0)), Negative = length(which(res@listData$stat[degs]&lt;0))))
  }
}
allPairs &lt;- allPairs[order(allPairs$NumberDEG),]
allPairs</code></pre>
<pre><code>[1] Treatment1 Treatment2 NumberDEG 
&lt;0 rows&gt; (or 0-length row.names)</code></pre>
<p>Save DEGs for each pair</p>
<pre class="r"><code>topGenes = list()

for (i in 1:(length(uTreat)-1)){
  for (j in (i+1):length(uTreat)){
    degList = data.frame(genes = character(), pval = numeric())
    res &lt;- results(dds, contrast=c(&quot;treatment&quot;,uTreat[i],uTreat[j]))
    deg &lt;- which((res@listData)$padj &lt;0.05)
    pval &lt;- (res@listData)$padj[deg]
    genes &lt;- res@rownames[deg]
    degList = rbind(degList, data.frame(genes = genes, pval = pval))
    topGenes[[ paste0(uTreat[i], uTreat[j]) ]] &lt;- degList
  }
}
saveRDS(topGenes, file=&quot;topGenes_DEG.Rds&quot;)</code></pre>
<pre class="r"><code>#plotMA(res, ylim = c(-1, 1000000), xlim=c(-1, 200000))
plotMA(res)</code></pre>
<p><img src="DESeq_Script_files/figure-html/unnamed-chunk-18-1.png" width="960" /></p>
<pre class="r"><code>plotDispEsts(dds, ylim = c(1e-6, 1e1))</code></pre>
<p><img src="DESeq_Script_files/figure-html/unnamed-chunk-19-1.png" width="960" /></p>
<p>The histogram of p-values does not look too good.</p>
<pre class="r"><code>hist( res$pvalue, breaks=20, col=&quot;grey&quot; )</code></pre>
<p><img src="DESeq_Script_files/figure-html/unnamed-chunk-20-1.png" width="960" /></p>
<p>Below has y-axis that doesn’t add to 1 for some reason (neither does the example in the vignette)</p>
<pre class="r"><code># create bins using the quantile function
qs &lt;- c( 0, quantile( res$baseMean[res$baseMean &gt; 0], 0:7/7 ) )
# &quot;cut&quot; the genes into the bins
bins &lt;- cut( res$baseMean, qs )
# rename the levels of the bins using the middle point
levels(bins) &lt;- paste0(&quot;~&quot;,round(.5*qs[-1] + .5*qs[-length(qs)]))
# calculate the ratio of £p£ values less than .01 for each bin
ratios &lt;- tapply( res$pvalue, bins, function(p) mean( p &lt; .01, na.rm=TRUE ) ) # plot these ratios
barplot(ratios, xlab=&quot;mean normalized count&quot;, ylab=&quot;ratio of small $p$ values&quot;)</code></pre>
<p><img src="DESeq_Script_files/figure-html/unnamed-chunk-21-1.png" width="960" /></p>
<p>Taking rlog transformation for EDA.</p>
<pre class="r"><code>rld &lt;- rlog(dds)
par( mfrow = c(1, 2))
plot(log2(1+counts(dds, normalized=TRUE)[, 1:2] ), col=&quot;#00000020&quot;, pch=20, cex=0.3)
plot(assay(rld)[, c(2,3)], col=&quot;#00000020&quot;, pch=20, cex=0.3)</code></pre>
<p><img src="DESeq_Script_files/figure-html/unnamed-chunk-22-1.png" width="960" /></p>
<p>assay(rld)</p>
<pre class="r"><code>ggparcoord(data.frame(counts(dds, normalized=TRUE)/colMeans(counts(dds, normalized=TRUE))), columns=1:48, alphaLines=0, boxplot=TRUE, scale=&quot;globalminmax&quot;) + coord_flip()</code></pre>
<p><img src="DESeq_Script_files/figure-html/unnamed-chunk-23-1.png" width="960" /></p>
<pre class="r"><code>ggparcoord(data.frame(log2(1+counts(dds, normalized=TRUE))/colMeans(log2(1+counts(dds, normalized=TRUE)))), columns=1:48, alphaLines=0, boxplot=TRUE, scale=&quot;globalminmax&quot;) + coord_flip()</code></pre>
<p><img src="DESeq_Script_files/figure-html/unnamed-chunk-23-2.png" width="960" /></p>
<pre class="r"><code>ggparcoord(data.frame(assay(rld)/colMeans(assay(rld))), columns=1:48, alphaLines=0, boxplot=TRUE, scale=&quot;globalminmax&quot;) + coord_flip()</code></pre>
<p><img src="DESeq_Script_files/figure-html/unnamed-chunk-23-3.png" width="960" /></p>
<pre class="r"><code>sampleDists &lt;- dist( t( assay(rld) ) )</code></pre>
<pre class="r"><code>sampleDistMatrix &lt;- as.matrix(sampleDists)
rownames(sampleDistMatrix) &lt;- paste(rld$treatment, rld$patient, sep=&quot;-&quot;)
colnames(sampleDistMatrix) &lt;- NULL
library(&quot;gplots&quot;)
library(&quot;RColorBrewer&quot;)
colours = colorRampPalette(rev(brewer.pal(9, &quot;Blues&quot;)))(255)
heatmap.2(sampleDistMatrix, trace=&quot;none&quot;, col=colours)</code></pre>
<p><img src="DESeq_Script_files/figure-html/unnamed-chunk-25-1.png" width="960" /></p>
<pre class="r"><code>print(plotPCA(rld, intgroup=&quot;treatment&quot;) + geom_text(aes(label = rownames(rld@colData))))</code></pre>
<p><img src="DESeq_Script_files/figure-html/unnamed-chunk-26-1.png" width="960" /></p>
<pre class="r"><code>#topVarGenes &lt;- head( order( rowVars( assay(rld) ), decreasing=TRUE ), 35 )
#heatmap.2( assay(rld)[ topVarGenes, ], scale=&quot;row&quot;, trace=&quot;none&quot;, dendrogram=&quot;column&quot;, col = colorRampPalette( rev(brewer.pal(9, &quot;RdBu&quot;)) )(255))</code></pre>


      </div>
    </div>
  </div>

  <div id="footer">
    <div class="container">
      <div class="col-md-6">
              </div>
      <div class="col-md-6">
        <p class="pull-right">created with <a href="https://github.com/hafen/packagedocs">packagedocs</a>
                  </p>
      </div>
    </div>
  </div>

  
</body>
</html>
