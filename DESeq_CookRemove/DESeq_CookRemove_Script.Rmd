---
title: "Honey Bees - DESeq"
author: Lindsay Rutter
output:
  packagedocs::package_docs:
    toc: true
    toc_collapse: true
vignette: >
  %\VignetteEngine{packagedocs::redirect}
---

<meta http-equiv="content-type" content="text/html;charset=utf-8" />

```{r global_options, include=FALSE}
# R output pre blocks are styled by default to indicate output
knitr::opts_chunk$set(
  comment = NA,
  cache = TRUE,
  fig.height = 8,
  fig.width = 10
)
```

```{r}
library(DESeq2)

thisPath <- "/Users/lindz/BeeVirusDiet/DESeq"

beeCounts <-read.delim(file="../AllLaneCount.txt",row.names=1,stringsAsFactors = FALSE)
colnames(beeCounts) <- c("NC.1", "NC.2", "NR.1", "VR.1", "NS.1", "VP.1", "NS.2", "VR.2", "NP.1", "VP.2", "VC.1", "NP.2", "VP.3", "NP.3", "VS.1", "VS.2", "VC.2", "NC.3", "VP.4", "NC.4", "NR.2", "VC.3", "VC.4", "NP.4", "VR.3", "NC.5", "VS.3", "NP.5", "VC.5", "VS.4", "NS.3", "VS.5", "VP.5", "NR.3", "NR.4", "VC.6", "NS.4", "NC.6", "NP.6", "VR.4", "NR.5", "NR.6", "NS.5", "VP.6", "NS.6", "VR.5", "VR.6", "VS.6")
countdata <- beeCounts[ , order(names(beeCounts))]
countdata <- as.matrix(countdata)

coldata = data.frame(row.names = colnames(countdata), virus = unlist(lapply(colnames(countdata), function (x) substring(unlist(strsplit(x, "[.]"))[1],1,1))), diet = unlist(lapply(colnames(countdata), function (x) substring(unlist(strsplit(x, "[.]"))[1],2,2))), treatment = unlist(lapply(colnames(countdata), function (x) unlist(strsplit(x, "[.]"))[1])))

# Not sure which to do
#dds = DESeqDataSetFromMatrix(countData = countdata, colData = coldata, design = ~ virus + diet)
#dds = DESeqDataSetFromMatrix(countData = countdata, colData = coldata, design = ~ virus + diet + virus:diet)
dds = DESeqDataSetFromMatrix(countData = countdata, colData = coldata, design = ~ treatment)
dds <- DESeq(dds)
```

There are 1189 genes that have zero counts across all samples.

```{r}
# 1189 genes (7.7% of total) have all zero counts
length(which(mcols(dds)$allZero))
```

Now we can examine some of the Cook's distance measurements. The default cut-off for Cook's distance is the 99% quantile of F(p,m-p) where p is the number of parameters (including intercept) and m is the number of samples.

```{r}
# If m=48 and p=9, cutoff value is 2.900968
qf(.99, df1=9, df2=39)
# If m=12 and p=3, cutoff value is 6.991917
qf(.99, df1=3, df2=9)
```

There are very few genes that would be filtered out from Cook's filter upon looking at the summary of Cook's values. 35 genes in 7 samples have at least one gene greater than 2.900968 (NC.3, NP.2, NP.5, NR.3, NS.1, NS.3, VC.6). 20 genes in 5 samples (NP.2, NP.5, NR.3, NS.1, VC.6) has at least one gene greater than 6.99.
 
```{r}
cookValues = assays(dds)[["cooks"]]
# Each column has 1189 NA values for Cook Values (because all zeros)
apply(cookValues, 2, max, na.rm = TRUE)

which(apply(cookValues, 2, max, na.rm = TRUE) > 2.900)
length(which(cookValues > 2.900))
```


```{r}
res <- results(dds, contrast=c("treatment","NC","NP"))
# 6916 padj have value NA
table(is.na(res@listData$padj))

res <- results(dds, contrast=c("treatment","NC","NR"))
# 5555 padj have value NA
table(is.na(res@listData$padj))
```

We can examine pairwise combinations of all samples


```{r}
outDir = "/Users/lindz/BeeVirusDiet/staticHexRLog-CookFilter"

my_fn <- function(data, mapping, ...){
  x = data[,c(as.character(mapping$x))]
  y = data[,c(as.character(mapping$y))]
  h <- hexbin(x=x, y=y, xbins=xbins, shape=1, IDs=TRUE, xbnds=maxRange, ybnds=maxRange)
  hexdf <- data.frame (hcell2xy (h),  hexID = h@cell, counts = h@count)
  attr(hexdf, "cID") <- h@cID
  p <- ggplot(hexdf, aes(x=x, y=y, fill = counts, hexID=hexID)) + geom_hex(stat="identity") + geom_abline(intercept = 0, color = "red", size = 0.25) + coord_cartesian(xlim = c(-1*buffer, maxRange[2]+buffer), ylim = c(-1*buffer, maxRange[2]+buffer))
  p
}



```

```{r}
uTreat <- unique(unlist(lapply(colnames(countdata), function (x) unlist(strsplit(x, "[.]"))[1])))

allPairs = data.frame(Treatment1 = factor(), Treatment2 = factor(), NumberDEG = numeric())

for (i in 1:(length(uTreat)-1)){
  for (j in (i+1):length(uTreat)){
    res <- results(dds, contrast=c("treatment",uTreat[i],uTreat[j]))
    numKeep <- length(which(!is.na(res@listData$padj)))
    
    rld <- rlog(dds)


    bindata <- as.data.frame(assay(rld))
    setDT(bindata, keep.rownames = TRUE)[]
    colnames(bindata)[1] <- "ID"
    bindata$ID <- as.character(bindata$ID)
    colNames <- colnames(bindata)
    myPairs <- unique(sapply(colNames, function(x) unlist(strsplit(x,"[.]"))[1]))
    myPairs <- myPairs[-which(myPairs=="ID")]
    colGroups <- sapply(colNames, function(x) unlist(strsplit(x,"[.]"))[1])
    bindata <- as.data.frame(bindata)
    
    
    allPairs = rbind(allPairs, data.frame(Treatment1 = uTreat[i], Treatment2 = uTreat[j], NumberNA = numKeep))
  }
}
allPairs <- allPairs[order(allPairs$NumberDEG),]
allPairs
```
